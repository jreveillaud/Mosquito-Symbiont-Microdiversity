---
title: "Beta diversity"
author: "Hans Schrieke and Julie Reveillaud"
date: "`r Sys.Date()`"
output: 
  rmdformats::readthedown:
    lightbox: true
    gallery: false
    fig_caption: true
    highlight: tango
    toc_depth: 3
    code_folding: "hide"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



# Paths and libraries setting

```{r, warning=FALSE, message=FALSE}
# Load main packages, paths and custom functions
source("../../../source/main_packages.R")
source("../../../source/paths.R")
source("../../../source/functions.R")

# Load supplementary packages
packages <- c("openxlsx", "kableExtra", "dynamicTreeCut", "cowplot", "ggpubr")
invisible(lapply(packages, require, character.only = TRUE))
```

# HCA on raw data

## Preparation

```{r warning=FALSE}
# load rdata file with phyloseq object
setwd(path_rdata)
ps <- readRDS("MED_phyloseq.rds")

# transform count table into percent table
ps.percent <- transform_sample_counts(ps, (function(x) x / sum(x)))

# extract otu and tax tables
otu <- data.frame(ps.percent@otu_table)
tax <- data.frame(ps.percent@tax_table)
sam <- data.frame(ps.percent@sam_data)

# add Genus column in otu table
otu$Genus <- tax$Genus
otu <- otu %>% select(c(Genus, everything()))

# select Wolbachia
otu_wolbachia <- otu[otu$Genus=="Wolbachia" & !is.na(otu$Genus),] %>% t() 
otu_wolbachia <- otu_wolbachia[-1,]

# add sample names as rownames
samples_names <- rownames(otu_wolbachia)

# convert column into numeric type
otu_wolbachia <- data.frame(apply(otu_wolbachia, 2, function(x) as.numeric(as.character(x))))

# add column Wolbachia with sum of Wolbachia percentage
otu_wolbachia$Wolbachia <- rowSums(otu_wolbachia)

# set rownames 
rownames(otu_wolbachia) <- samples_names

# add column Sample with sample id
otu_wolbachia$Sample <- rownames(otu_wolbachia)
otu_wolbachia <- otu_wolbachia %>% select(c(Sample, Wolbachia))

# print
otu_wolbachia %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)
```


## HCA

### Run HCA
```{r}
# Compute distance on samples with Wolbachia
d.wolbachia <- dist(otu_wolbachia[,-1, drop=FALSE], method="euclidean")

# HCA
hca.ward <- hclust(d.wolbachia,method="ward.D2")
```

### Dendogram
```{r width=12, warning=FALSE}
# 2 groups
plot(hca.ward)
rect.hclust(hca.ward,k=2)

# 3 groups
plot(hca.ward, ask=FALSE)
rect.hclust(hca.ward, k=3)

# set displaying
rh <- rect.hclust(hca.ward, k=3, border = c("red", "blue", "grey"))
beg_clus <- head(cumsum(c(1, lengths(rh))), -1)
beg_clus <- beg_clus + 5
y_clus <- weighted.mean(rev(hca.ward$height)[2:3], c(4, 1))

# plot
plot(hca.ward, cex=0.7) 
rect.hclust(hca.ward, k=3, border = c("red", "blue", "grey"))
text(x=beg_clus, y=y_clus, col=c("red","blue", "grey"), labels=c("High infection", "Low infection", "Medium infection"), font=2)



# save plot
setwd(path_plot)
tiff("1Ec_dendogram.tiff", units="in", width=18, height=8, res=300)
plot(hca.ward, cex=0.7, xlab="Samples", sub="") 
rect.hclust(hca.ward, k=3, border = c("red", "blue", "grey"))
text(x=beg_clus, y=y_clus, col=c("red","blue", "grey"), labels=c("High infection", "Low infection", "Medium infection"), font=2)
dev.off()

png("1Ec_dendogram.png", units="in", width=18, height=8, res=300)
plot(hca.ward, cex=0.7, xlab="Samples", sub="") 
rect.hclust(hca.ward, k=3, border = c("red", "blue", "grey"))
text(x=beg_clus, y=y_clus, col=c("red","blue", "grey"), labels=c("High infection", "Low infection", "Medium infection"), font=2)
dev.off()

```

### Split
```{r}
# split into 3 groups
hca.groups <- cutree(hca.ward, k=3)

# list of groups
print(sort(hca.groups))
```

## Make a dataframe from these groups

```{r}
# df
wolbachia.groups <- print(sort(hca.groups)) %>% as.data.frame()

# change colnames
colnames(wolbachia.groups) <- "Group"

# change rownames
wolbachia.groups$Sample <- rownames(wolbachia.groups)

# add Group to otu_wolbachia with merge
wolbachia.groups <- wolbachia.groups %>% merge(otu_wolbachia %>% select(c(Sample, Wolbachia)), by="Sample")

# change rownames
rownames(wolbachia.groups) <- wolbachia.groups$Sample

# print
wolbachia.groups %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)
```

## Groups statistics

### With raw labels
```{r}
# convert summary to table
summary.table <- function(df, n, var){
var <- df[df$Group==n, var]
x <- summary(var)
a <- data.frame(x=matrix(x),row.names=names(x))
colnames(a) <- n
return(a)
}

# make table with stats
wolbachia.summary <- summary.table(wolbachia.groups, 1, "Wolbachia") %>% cbind(summary.table(wolbachia.groups, 2, "Wolbachia")) %>% cbind(summary.table(wolbachia.groups, 3, "Wolbachia"))

# print
wolbachia.summary %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)
```

### With new labels
```{r}
# print levels of Group
levels(wolbachia.groups$Group %>% as.factor)

# change levels of Group
wolbachia.groups[wolbachia.groups$Group==1, "Group"] <- "Low infection"
wolbachia.groups[wolbachia.groups$Group==2, "Group"] <- "Medium infection"
wolbachia.groups[wolbachia.groups$Group==3, "Group"] <- "High infection"

# make table with stats
wolbachia.summary.labels <- summary.table(wolbachia.groups, "Low infection", "Wolbachia") %>% cbind(summary.table(wolbachia.groups, "Medium infection", "Wolbachia")) %>% cbind(summary.table(wolbachia.groups, "High infection", "Wolbachia"))

# print
wolbachia.summary.labels %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)
```


# HCA on qPCR data

## Preparation

```{r warning=FALSE}
# load qPCR file
setwd(path_qpcr)
qpcr <- read.xlsx("quanttiWolbachiaschriekeetal.xlsx")

# select Target/ref column
qpcr <- qpcr[,c("Sample.Name", "Target/Ref")]
colnames(qpcr) <- c("Sample", "Ratio_Target_Ref")

# remove the bad S45 sample
qpcr <- qpcr[-28,]
rownames(qpcr) <- qpcr$Sample

# samples without Wolbachia
qpcr_no_wolbachia <- qpcr[qpcr$Ratio_Target_Ref==0,]
qpcr_no_wolbachia$Group <- 0
qpcr_no_wolbachia <- qpcr_no_wolbachia %>% select(-c(Ratio_Target_Ref))

# samples with Wolbachia
qpcr_wolbachia <- qpcr[qpcr$Ratio_Target_Ref!=0,]

# print samples without Wolbachia
qpcr_no_wolbachia %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)

# print samples with Wolbachia
qpcr_wolbachia %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)

# add column with true ID in qpcr table
setwd(path_qpcr)
metadata <- openxlsx::read.xlsx("Supplementary_Table_1_V4_Shorten_w_ReadDepth_CheckqPCR.xlsx", sheet=1)
qpcr$True_TubeID <- rownames(qpcr)
qpcr <- qpcr %>% merge(metadata, by="True_TubeID", all.x=TRUE)
qpcr <- qpcr %>% select(c(True_TubeID, Sample.ID, Ratio_Target_Ref))

# print the qpcr table
qpcr %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)
```


## HCA

### Run HCA
```{r}
# Compute distance on samples with Wolbachia
d.wolbachia <- dist(qpcr_wolbachia[,-1, drop=FALSE], method="euclidean")

# HCA
hca.ward <- hclust(d.wolbachia,method="ward.D2")
```

### Dendogram
```{r}
# 3 groups
plot(hca.ward)
rect.hclust(hca.ward, k=3)

# 2 groups
plot(hca.ward)
rect.hclust(hca.ward,k=2)
```

### Split
```{r}
# split into 3 groups
hca.groups <- cutree(hca.ward, k=2)

# list of groups
print(sort(hca.groups))
```

## Make a dataframe from these groups

### Create dataframe
```{r}
qpcr.groups <- print(sort(hca.groups)) %>% as.data.frame()
colnames(qpcr.groups) <- "Group"
qpcr.groups$Sample <- rownames(qpcr.groups)
```

### Add samples with no Wolbachia
```{r}
qpcr.groups <- qpcr.groups %>% rbind(qpcr_no_wolbachia)

# print
qpcr.groups %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)
```

### Add groups in the qpcr table
```{r}
rownames(qpcr) <- qpcr$True_TubeID
qpcr <- qpcr %>% merge(qpcr.groups, by="row.names")
rownames(qpcr) <- qpcr$Sample.ID
qpcr <- qpcr[,-1]
qpcr <- qpcr %>% select(-c(Sample))

# print the qpcr table
qpcr %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)
```

## Groups statistics

### With raw labels
```{r}
# make table with stats
qpcr.summary <- summary.table(qpcr, 0, "Ratio_Target_Ref") %>% cbind(summary.table(qpcr, 1, "Ratio_Target_Ref")) %>% cbind(summary.table(qpcr, 2, "Ratio_Target_Ref"))

# print
qpcr.summary %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)
```

### With new labels
```{r}
# print levels of Group
levels(qpcr$Group %>% as.factor)

# change levels of Group
qpcr[qpcr$Group==0, "Group"] <- "No infection"
qpcr[qpcr$Group==1, "Group"] <- "Low infection"
qpcr[qpcr$Group==2, "Group"] <- "High infection"

# make table with stats
qpcr.summary.labels <- summary.table(qpcr, "No infection", "Ratio_Target_Ref") %>% cbind(summary.table(qpcr, "Low infection", "Ratio_Target_Ref")) %>% cbind(summary.table(qpcr, "High infection", "Ratio_Target_Ref"))

# print
qpcr.summary.labels %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)
```

# NMDS (Non-metric MultiDimensional Scaling)

## Preparation

### Merge groups of data from phyloseq and data from qpcr
```{r warning=FALSE}
# print wolbachia.groups (phyloseq)
wolbachia.groups %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)

# print qpcr.groups (qpcr)
qpcr %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)

# merge 
colnames(wolbachia.groups) <- c("Sample", "Infection", "Wolbachia")
colnames(qpcr) <- c("qPCR_ID", "Sample", "qPCR_Ratio_Target_Ref", "qPCR_Infection")
all.groups <- wolbachia.groups %>% merge(qpcr, by="Sample", all.x=TRUE)

all.groups %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)

# optionnal : all.groups for comparison
all.groups.comparison <- wolbachia.groups %>% merge(qpcr, by="Sample")

all.groups.comparison <- all.groups.comparison %>% select(c(Sample, qPCR_ID, Infection, Wolbachia, qPCR_Ratio_Target_Ref, qPCR_Infection))

all.groups.comparison$Infection <- all.groups.comparison$Infection %>% as.factor()

all.groups.comparison$Infection <- factor(all.groups.comparison$Infection, levels = c("Low infection", "Medium infection", "High infection"))

all.groups.comparison <- all.groups.comparison[order(all.groups.comparison$Infection),]

all.groups.comparison %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)

all.groups.comparison <- all.groups.comparison %>% merge(sam %>% select(c(Sample, Strain, Species)), by="Sample")

all.groups.comparison <- all.groups.comparison[order(all.groups.comparison$Infection),]

all.groups.comparison %>%
  kbl(booktable=TRUE) %>%
  kable_paper("hover", full_width = F)

means <- aggregate(qPCR_Ratio_Target_Ref ~ Infection , all.groups.comparison, median)
means$qPCR_Ratio_Target_Ref <- means$qPCR_Ratio_Target_Ref %>% round(2)

ggqqplot(all.groups.comparison$Wolbachia)
shapiro.test(all.groups.comparison$Wolbachia)

my_comparisons <- list( c("Low infection", "Medium infection"), 
                        c("Medium infection", "High infection"), 
                        c("Low infection", "High infection") )

p1 <- ggplot(all.groups.comparison, aes(x=Infection, y=qPCR_Ratio_Target_Ref, fill=Infection)) + 
  geom_boxplot(alpha=0.6, outlier.shape = NA)+
        geom_jitter(position=position_jitter(0.5), aes(color=Infection), alpha=0.6) +
        theme_bw(base_size = 14)+
  scale_fill_manual(values = c("blue", "grey", "red"))+
  scale_color_manual(values = c("blue", "grey", "red"))+
  labs(x=expression(paste("\n", italic("Wolbachia"), "infection groups (from HCA)")), 
       y="Ratio Target Ref (qPCR)", 
       fill=expression(paste("\n", italic("Wolbachia"), "infection groups (from HCA)")))+
  guides(colour=FALSE)+
  #stat_summary(fun.y = "median", geom = "point", shape = 23, size = 3, fill = "white")+
  stat_compare_means(comparisons = my_comparisons,
                     method="wilcox.test", 
                     label="p.signif", 
                     vjust=1.5,
                     label.y = c(10, 11, 12))+
    stat_compare_means(comparisons = my_comparisons,
                     method="wilcox.test", 
                     label="p.format", 
                     label.y = c(10, 11, 12))+
  geom_text(data = means, aes(label = qPCR_Ratio_Target_Ref, y = qPCR_Ratio_Target_Ref + 0.6))

p1

p9 <- ggplot(all.groups.comparison, aes(x=Infection, y=Wolbachia, fill=Infection)) + 
  geom_boxplot(alpha=0.6, outlier.shape = NA)+
  geom_jitter(position=position_jitter(0.5), aes(color=Infection), alpha=0.6) +
  theme_bw(base_size = 14)+
  scale_fill_manual(values = c("blue", "grey", "red"))+
  scale_color_manual(values = c("blue", "grey", "red"))+
  labs(x=expression(paste("\n", italic("Wolbachia"), "infection groups (from HCA)")), 
       y=expression(paste("\n", italic("Wolbachia"), "infection (relative abundance)")), 
       fill="Infection")+
  guides(colour=FALSE)+ 
  scale_y_continuous(breaks = seq(0, 1, by = 0.1))

p9


setwd(path_tsv)
write.table(all.groups.comparison, "1Ec_qpcr_comparison.tsv", sep="\t", row.names = FALSE, col.names=TRUE)

setwd(path_plot)
tiff("1Ec_boxplot.tiff", units="in", width=10, height=5, res=300)
p1
dev.off()

png("1Ec_boxplot.png", units="in", width=10, height=5, res=300)
p1
dev.off()
```

### Add groups in decontam phyloseq object

```{r warning=FALSE}
# load phyloseq object after decontam
setwd(path_rdata)
ps.filter <- readRDS("1D_MED_phyloseq_decontam.rds")

# extract metadata
sam <- data.frame(ps.filter@sam_data)

# add groups in sam table
sam <- sam %>% merge(all.groups %>% select(c(Sample, Infection, Wolbachia, qPCR_Infection, qPCR_Ratio_Target_Ref)), by="Sample", all.x = TRUE)
rownames(sam)<- sam$Sample

# change levels for plot
# levels(sam$Strain) <- c(levels(sam$Strain), "Laboratory - Lavar", "Laboratory - Slab TC (Wolbachia -)")
# sam$Strain[sam$Strain=="Laboratory - Lavar"] <- "Laboratory - Lavar"
# sam$Strain[sam$Strain=="Wolbachia -"] <- "Laboratory - Slab TC (Wolbachia -)"
# sam$Strain <- droplevels(sam$Strain)
# levels(sam$Strain)

# add a column for qPCR measure
sam$qPCR_measure <- "Yes"
sam[is.na(sam$qPCR_Ratio_Target_Ref), "qPCR_measure"] <- "No"
sam[sam$qPCR_measure=="Yes" & sam$qPCR_Ratio_Target_Ref==0, "qPCR_measure"] <- "= 0 (Wolbachia -)"
sam[sam$qPCR_measure=="Yes" & sam$qPCR_Ratio_Target_Ref>0, "qPCR_measure"] <- "> 0 (Wolbachia +)"

# update sam table of phyloseq object
sample_data(ps.filter) <- sam

# transformation percent
ps_percent <- transform_sample_counts(ps.filter, function(x) x/sum(x)*100)

# select whole
ps_percent_whole <- subset_samples(ps_percent, Organ == "Whole")
```

## Compute Bray-Curtis distance
```{r}
set.seed(35)
bray.culex_whole <- ordinate(ps_percent_whole, method="NMDS", distance="bray", trymax=300)
```

## Plot

### Raw data

```{r}
# all info
p1 <- plot_ordination(ps_percent_whole, bray.culex_whole, color="Infection", shape=NA) +
  labs(x="NMDS1", y = "NMDS2")+
  stat_ellipse(geom = "polygon", level=0.95, alpha = 0.25, aes(fill = Species, color=NA))+
  scale_fill_manual(values=c("orange", "yellow","green"), labels = c(expression(italic("Aedes aegypti")), expression(italic("Culex pipiens")), expression(italic("Culex quinquefasciatus"))))+
  scale_color_manual(values=c("blue", "grey","red"), breaks=c("Low infection", "Medium infection", "High infection"))+
  scale_shape_manual(values=c(19,17,15,4,7), labels=c("Field - Bosc", "Field - Camping Europe", "Field - Guadeloupe", "Laboratory - Lavar", expression(paste("Laboratory - Slab TC (", italic("Wolbachia"), "-)"))))+
  theme_gray()+
  labs(caption=paste("stress:", bray.culex_whole$stress %>% round(2), "\n", "ellipse level: 0.95"))+
  #expand_limits(x=c(-2.5, 1.5), y=c(-2, 2.5))+
  guides(fill = guide_legend(order = 1),
         colour = guide_legend(order = 2),
         shape = guide_legend(order = 3))+
  labs(fill="Species", col="Wolbachia Group")+
  geom_text(mapping = aes(label = Sample), size = 1.5, vjust = 3)+
  theme(legend.text.align = 0)

p1$layers[[1]] <- NULL
p1[["guides"]][["shape"]][["title"]] <- "Strain"
p1[["guides"]][["colour"]][["title"]] <- expression(paste(italic("Wolbachia"), "Infection"))

p1+
  geom_point(aes(shape = Strain), size = 2)
```
```{r}
# Wolbachia infection

p2 <- plot_ordination(ps_percent_whole, bray.culex_whole, color="Infection", shape="qPCR_measure") +
  
  scale_color_manual(values=c("blue", "#E4A7F5","red"), 
                     breaks=c("Low infection", "Medium infection", "High infection"))+
  scale_fill_manual(expression(paste(italic("Wolbachia"), "Infection")), 
                    values=c("blue", "#E4A7F5","red"), 
                    breaks=c("Low infection", "Medium infection", "High infection"))+
  scale_shape_manual("qPCR", 
                     values=c(7,2,19), 
                     labels=c(expression(paste("= 0 (", italic("Wolbachia"), "-)")), 
                              expression(paste("> 0 (", italic("Wolbachia"), "+)")), 
                              "No qPCR"))+
  labs(x="NMDS1", 
       y = "NMDS2",
       caption=paste("stress:", bray.culex_whole$stress %>% round(2), "\n", "ellipse level: 0.95"))+
  
  geom_text(mapping = aes(label = Sample), size = 1.5, vjust = 3)+
  
  stat_ellipse(geom = "polygon", 
               alpha = 0.25, 
               aes(fill=Infection, group=Infection))+
  
  coord_cartesian(xlim = c(-2.8,2.8), ylim=c(-2.5,2.2))+
  #expand_limits(x=c(-2.5, 1.5), y=c(-2, 2.5))+
  
  guides(fill = guide_legend(order = 1),
         shape = guide_legend(order = 2),
         colour=FALSE)+
  
  theme(legend.text.align = 0)

p2
``` 

```{r}
# species ("orange", "yellow", "green")
p3 <- plot_ordination(ps_percent_whole, bray.culex_whole, color="Species") +
  
  geom_point(size = 2) +
  
  scale_fill_manual(values=c("#F57462", "#498CF5","#559E36"), 
                    labels = c(expression(italic("Aedes aegypti")), 
                               expression(italic("Culex pipiens")), 
                               expression(italic("Culex quinquefasciatus"))))+
  
  scale_color_manual(values=c("#F57462", "#498CF5","#559E36"))+
  
  labs(x="NMDS1", 
       y = "NMDS2",
       caption=paste("stress:", bray.culex_whole$stress %>% round(2), "\n", "ellipse level: 0.95"))+
  
  geom_text(mapping = aes(label = Sample), size = 1.5, vjust = 3)+
  
  stat_ellipse(geom = "polygon", 
               alpha = 0.25, 
               aes(fill = Species))+
  
  coord_cartesian(xlim = c(-2.8,2.8), ylim=c(-2.5,2.2))+
  #expand_limits(x=c(-2.5, 1.5), y=c(-2, 2.5))+
  
  guides(fill = guide_legend(order = 1),
         colour = FALSE,
         shape = guide_legend(order = 3))+
  
  
  theme(legend.text.align = 0)

p3
```
```{r}
# Strain
new_location <- c("Field - Guadeloupe", "Laboratory - Slab TC (Wolbachia -)", 
                  "Field - Bosc", "Field - Camping Europe", "Laboratory - Lavar")
ps_percent_whole@sam_data$Strain <- factor(ps_percent_whole@sam_data$Strain, levels = new_location)

p4 <- plot_ordination(ps_percent_whole, bray.culex_whole, color="Strain") +
  
  geom_point(size = 2) +
  
  scale_fill_manual("Strain", 
                    values=c("#00BF7D", "#5B6BF7", "#A3A500", "#F8766D", "#00B0F6"),
                    labels = c("Field - Guadeloupe", 
                               expression(paste("Laboratory - Slab TC (", italic("Wolbachia"), "-)")),
                               "Field - Bosc", 
                               "Field - Camping Europe", 
                               "Laboratory - Lavar"))+
  scale_color_manual("Strain", 
                     values=c("#00BF7D", "#5B6BF7", "#A3A500", "#F8766D", "#00B0F6"),
                     labels = c("Field - Guadeloupe", 
                                expression(paste("Laboratory - Slab TC (", italic("Wolbachia"), "-)")),
                                "Field - Bosc", 
                                "Field - Camping Europe", 
                                "Laboratory - Lavar"))+
  
  labs(x="NMDS1", 
       y = "NMDS2",
       caption=paste("stress:", bray.culex_whole$stress %>% round(2), "\n", "ellipse level: 0.95"))+
  
  stat_ellipse(geom = "polygon", alpha = 0.25, aes(fill=Strain, group=Strain))+
  
  coord_cartesian(xlim = c(-2.8,2.8), ylim=c(-2.5,2.2))+
  #expand_limits(x=c(-2.5, 1.5), y=c(-2, 2.5))+
  
  guides(fill = guide_legend(order = 1),
         colour = FALSE,
         shape = guide_legend(order = 3))+
  
  geom_text(mapping = aes(label = Sample), size = 1.5, vjust = 3)+
  theme(legend.text.align = 0)

p4
```
```{r}
# field
p5 <- plot_ordination(ps_percent_whole, bray.culex_whole, color="Field") +
  geom_point(size = 2) +
  scale_fill_manual(values=c("brown", "purple" ))+
  scale_color_manual(values=c("brown", "purple"))+
  
  labs(x="NMDS1", 
       y = "NMDS2", 
       caption=paste("stress:", bray.culex_whole$stress %>% round(2), "\n", "ellipse level: 0.95"))+
  
  stat_ellipse(geom = "polygon", alpha = 0.25, aes(fill=Field, group=Field))+
  
  #coord_cartesian(xlim = c(-2,2.8), ylim=c(-2,1.5))+
  coord_cartesian(xlim = c(-2.8,2.8), ylim=c(-2.5,2.2))+
  #expand_limits(x=c(-2.5, 1.5), y=c(-2, 2.5))+
  
  guides(fill = guide_legend(order = 1),
         colour = FALSE,
         shape = guide_legend(order = 3))+
  
  geom_text(mapping = aes(label = Sample), size = 1.5, vjust = 3)

p5
```

```{r}
# species + strains
p6 <- plot_ordination(ps_percent_whole, bray.culex_whole, color="Strain", shape=NA) +
  labs(x="NMDS1", y = "NMDS2")+
  scale_color_manual("Strain", 
                     values=c("#00BF7D", "#5B6BF7", "#A3A500", "#F8766D", "#00B0F6"),
                     labels = c("Field - Guadeloupe", 
                                expression(paste("Laboratory - Slab TC (", italic("Wolbachia"), "-)")),
                                "Field - Bosc", 
                                "Field - Camping Europe", 
                                "Laboratory - Lavar"))+
  scale_shape_manual(values = c(15,16,17), labels=c(expression(italic("Aedes aegypti")), expression(italic("Culex pipiens")), expression(italic("Culex quinquefasciatus"))))+
  theme_gray()+
  #labs(caption=paste("stress:", bray.culex_whole$stress %>% round(2), "\n", "ellipse level: 0.95"))+
  guides(fill = guide_legend(order = 1),
         colour = guide_legend(order = 2),
         shape = guide_legend(order = 3))+
  geom_text(mapping = aes(label = Sample), size = 1.5, vjust = 3)+
  theme(legend.text.align = 0)+
  geom_point(aes(shape = Species_italic), size = 2)

p6$layers[[1]] <- NULL
p6[["guides"]][["shape"]][["title"]] <- "Species"

p6
```

```{r}
sam2 <- sam[sam$Species=="Culex pipiens",]

means <- aggregate(Wolbachia ~ Strain , sam2, median)
means$Wolbachia <- means$Wolbachia %>% round(2)

ggqqplot(sam2$Wolbachia)
shapiro.test(sam2$Wolbachia)

my_comparisons <- list( c("Field - Bosc", "Field - Camping Europe"), 
                        c("Field - Camping Europe", "Laboratory - Lavar"), 
                        c("Field - Bosc", "Laboratory - Lavar") )

p7 <- ggplot(sam2, aes(x=Strain, y=Wolbachia, fill=Strain)) + 
  geom_boxplot(alpha=0.6, outlier.shape = NA)+
  geom_jitter(position=position_jitter(0.5), aes(color=Strain), alpha=0.6) +
  theme_bw(base_size = 14)+
  scale_fill_manual(values = c("blue", "grey", "red"))+
  scale_color_manual(values = c("blue", "grey", "red"))+
  labs(x="\nStrain", 
       y=expression(paste("\n", italic("Wolbachia"), "infection (relative abundance)")),
       fill="Strain")+
  guides(colour=FALSE)+
  #stat_summary(fun = "mean", geom = "point", shape = 23, size = 3, fill = "white")+
  stat_compare_means(comparisons = my_comparisons,
                     method="wilcox.test", 
                     label="p.signif", 
                     vjust=1.5,
                     label.y = c(1.1, 1.2, 1.3))+
  stat_compare_means(comparisons = my_comparisons,
                     method="wilcox.test", 
                     label="p.format", 
                     label.y = c(1.1, 1.2, 1.3))+
  geom_text(data = means, aes(label = Wolbachia, y = Wolbachia - 0.05))

p7

means <- aggregate(qPCR_Ratio_Target_Ref ~ Strain , sam2, median)
means$qPCR_Ratio_Target_Ref<- means$qPCR_Ratio_Target_Ref %>% round(2)

wilcox.test(qPCR_Ratio_Target_Ref ~ Strain, sam2[sam2$Strain!="Field - Camping Europe",])

sam3 <- na.omit(sam2)
ggqqplot(sam3$qPCR_Ratio_Target_Ref)
shapiro.test(sam3$qPCR_Ratio_Target_Ref)

p8 <- ggplot(na.omit(sam2), aes(x=Strain, y=qPCR_Ratio_Target_Ref, fill=Strain)) + 
  geom_boxplot(alpha=0.6, outlier.shape = NA)+
  geom_jitter(position=position_jitter(0.5), aes(color=Strain), alpha=0.6) +
  theme_bw(base_size = 14)+
  scale_fill_manual(values = c("blue", "grey", "red"))+
  scale_color_manual(values = c("blue", "grey", "red"))+
  labs(x="\nStrain", y="Ratio Target Ref (qPCR)", fill="Strain")+
  guides(colour=FALSE)+
  #stat_summary(fun = "median", geom = "point", shape = 23, size = 3, fill = "white")+
  stat_compare_means(comparisons = my_comparisons,
                     method="wilcox.test", 
                     label="p.signif", 
                     vjust=1.5,
                     label.y = c(10, 11, 12))+
  stat_compare_means(comparisons = my_comparisons,
                     method="wilcox.test", 
                     label="p.format", 
                     label.y = c(10, 11, 12))+
  geom_text(data = means, aes(label = qPCR_Ratio_Target_Ref, y = qPCR_Ratio_Target_Ref + 0.4))

p8

ggplot(na.omit(sam2), aes(x=Wolbachia, y=qPCR_Ratio_Target_Ref))+
  geom_line()

x <- sam3$Wolbachia %>% log10
y <- sam3$qPCR_Ratio_Target_Ref %>% log10

plot(x, y, pch = 19, col = "lightblue")
abline(lm(y ~ x), col = "red", lwd = 3)
text(paste("Correlation:", round(cor(x, y), 2)), x = -0.6, y = 0.2)
```


```{r fig.width=12, fig.height=10, warning=FALSE}
# panels
p_group <- plot_grid(p2,
                     p3,
                     p4,
                     p5,
                     nrow=2, 
                     ncol=2,
                     align="hv",
                     labels=c("A","B","C", "D")
                     )

p_group

p_group2 <- plot_grid(p7,
                      p8,
                      nrow=1, 
                      align="h",
                     labels=c("A","B"))

p_group2

#ggarrange(p2, p3, p4, p5,nrow=2)

# save
setwd(path_plot)

tiff("1Ec_NMDS_main.tiff", units="in", width=8, height=5, res=300)
p6
dev.off()

tiff("1Ec_NMDS_supp.tiff", units="in", width=16, height=5, res=300)
p_group2
dev.off()

tiff("1Ec_MED_panels.tiff", units="in", width=14, height=10, res=300)
p_group
dev.off()

png("1Ec_NMDS_main.png", units="in", width=8, height=5, res=300)
p6
dev.off()

png("1Ec_NMDS_supp.png", units="in", width=16, height=5, res=300)
p_group2
dev.off()

png("1Ec_MED_panels.png", units="in", width=14, height=10, res=300)
p_group
dev.off()
```


### qPCR data

```{r}
# all info
p1 <- plot_ordination(ps_percent_whole, bray.culex_whole, color="qPCR_Infection", shape=NA) +
  labs(x="NMDS1", y = "NMDS2")+
  stat_ellipse(geom = "polygon", level=0.95, alpha = 0.25, aes(fill = Species, color=NA))+
  scale_fill_manual(values=c("orange", "yellow","green"), labels = c(expression(italic("Aedes aegypti")), expression(italic("Culex pipiens")), expression(italic("Culex quinquefasciatus"))))+
  scale_color_manual(values=c("black", "blue", "red"), breaks=c("No infection", "Low infection", "High infection"))+
  theme_gray()+
  labs(caption=paste("stress:", bray.culex_whole$stress %>% round(2), "\n", "ellipse level: 0.95"))+
  expand_limits(x=c(-2.5, 1.5), y=c(-2, 2.5))+
  guides(fill = guide_legend(order = 1),
         colour = guide_legend(order = 2),
         shape = guide_legend(order = 3))+
  labs(fill="Species", col="Wolbachia Group")+
  geom_text(mapping = aes(label = Sample), size = 1.5, vjust = 3)+
  theme(legend.text.align = 0)

p1$layers[[1]] <- NULL
p1[["guides"]][["shape"]][["title"]] <- "Strain"
p1[["guides"]][["colour"]][["title"]] <- expression(paste(italic("Wolbachia"), "Infection"))

p1+
  geom_point(aes(shape = Strain), size = 2)
```

# Statistical analysis

## Effect of field

```{r warning=FALSE, message=FALSE}
require(vegan)
setwd(path_xlsx)

# Select pipiens whole from 
ps_pipiens <- ps.filter %>% subset_samples(Species=="Culex pipiens")
ps_pipiens <- check_ps(ps_pipiens)
ps_pipiens_whole <- ps_pipiens %>% subset_samples(Organ=="Whole")
ps_pipiens_whole_bosc_lavar <- subset_samples(ps_pipiens_whole, Strain!="Field - Camping Europe")
ps_pipiens_whole_camping_lavar <- subset_samples(ps_pipiens_whole, Strain!="Field - Bosc")
ps_pipiens_whole_bosc_camping <- subset_samples(ps_pipiens_whole, Strain!="Laboratory - Lavar")

# Adonis method

## Bosc / Lavar
adonis_field_bosc_lavar <- adonis(vegdist(t(otu_table(ps_pipiens_whole_bosc_lavar)), method = "bray") ~Field,
       data=as(sample_data(ps_pipiens_whole_bosc_lavar), "data.frame"), permutation = 9999)

res_adonis1 <- adonis_field_bosc_lavar$aov.tab
res_adonis1 <- fill_significance(res_adonis1,"Pr(>F)")


# Calculate bray curtis distance matrix
erie_bray <- phyloseq::distance(ps_pipiens_whole_bosc_camping, method = "bray")

# make a data frame from the sample_data
sampledf <- data.frame(sample_data(erie))

# Adonis test
adonis(erie_bray ~ Station, data = sampledf)





## Camping / Lavar
adonis_field_camping_lavar <- adonis(vegdist(t(otu_table(ps_pipiens_whole_camping_lavar)), method = "bray") ~Field,
       data=as(sample_data(ps_pipiens_whole_camping_lavar), "data.frame"), permutation = 9999)

res_adonis2 <- adonis_field_camping_lavar$aov.tab
res_adonis2 <- fill_significance(res_adonis2,"Pr(>F)")

## Bosc / Camping
adonis_field_bosc_camping <- adonis(vegdist(t(otu_table(ps_pipiens_whole_bosc_camping)), method = "bray") ~Strain,
       data=as(sample_data(ps_pipiens_whole_bosc_camping), "data.frame"), permutation = 9999)

res_adonis3 <- adonis_field_bosc_camping$aov.tab
res_adonis3 <- fill_significance(res_adonis3,"Pr(>F)")

# Excel
wb <- loadWorkbook("Supplementary_Table_2.xlsx")
addWorksheet(wb, "NMDS")

writeData(wb, "NMDS", "Effect of lab (and Strain) in the Culex pipiens samples", startCol = 1, startRow = 25)
writeData(wb, "NMDS", "ADONIS (Analysis of variance using distance matrices):", startCol = 1, startRow = 27)
writeData(wb, "NMDS", "Lavar / Bosc:", startCol = 1, startRow = 29)
writeData(wb, "NMDS", res_adonis1, startCol = 1, startRow = 30, rowNames=TRUE)
writeData(wb, "NMDS", "Lavar / Camping Europe:", startCol = 1, startRow = 35)
writeData(wb, "NMDS", res_adonis2, startCol = 1, startRow = 36, rowNames=TRUE)
writeData(wb, "NMDS", "Bosc / Camping Europe:", startCol = 1, startRow = 41)
writeData(wb, "NMDS", res_adonis3, startCol = 1, startRow = 42, rowNames=TRUE)


saveWorkbook(wb, "Supplementary_Table_2.xlsx", overwrite = TRUE)
```

## Effect of tetracycline
```{r warning=FALSE}
setwd(path_xlsx)

# Select quinque whole
ps_quinque <- ps.filter %>% subset_samples(Species=="Culex quinquefasciatus")
ps_quinque <- check_ps(ps_quinque)
ps_quinque_whole <- ps_quinque %>% subset_samples(Organ=="Whole")

# Adonis method
adonis_antibiotics <- adonis(vegdist(t(otu_table(ps_quinque_whole)), method = "bray") ~Field,
       data=as(sample_data(ps_quinque_whole), "data.frame"), permutation = 9999)

adonis_antibiotics$aov.tab 

res_adonis5 <- adonis_antibiotics$aov.tab %>% as.data.frame()
res_adonis5 <- fill_significance(res_adonis3,"Pr(>F)")

writeData(wb, "NMDS", "Effect of tetracycline in the Culex quinquefasciatus samples", startCol = 1, startRow = 13)
writeData(wb, "NMDS", "ADONIS (Analysis of variance using distance matrices):", startCol = 1, startRow = 15)
writeData(wb, "NMDS", res_adonis3, startCol = 1, startRow = 17, rowNames=TRUE)

saveWorkbook(wb, "Supplementary_Table_2.xlsx", overwrite = TRUE)
```

## Effect of species
```{r warning=FALSE}
setwd(path_xlsx)

ps_whole_field <- ps.filter %>% subset_samples(Field=="Field")

adonis_whole_field <- adonis(vegdist(t(otu_table(ps_whole_field)), method = "bray") ~Species,
       data=as(sample_data(ps_whole_field), "data.frame"), permutation = 9999)

res_adonis6 <- adonis_whole_field$aov.tab
res_adonis6 <- fill_significance(res_adonis6,"Pr(>F)")

writeData(wb, "NMDS", "Effect of species in the field samples", startCol = 1, startRow = 1)
writeData(wb, "NMDS", "ADONIS (Analysis of variance using distance matrices):", startCol = 1, startRow = 3)
writeData(wb, "NMDS", res_adonis6, startCol = 1, startRow = 5, rowNames=TRUE)

saveWorkbook(wb, "Supplementary_Table_2.xlsx", overwrite = TRUE)
```


## Effect of Wolbachia infection within Culex pipiens
```{r warning=FALSE}
setwd(path_xlsx)

# HCA Wolbachia infection * Strain
adonis_whole_infection <- adonis(vegdist(t(otu_table(ps_pipiens_whole)), method = "bray") ~Infection*Strain,
       data=as(sample_data(ps_pipiens_whole), "data.frame"), permutation = 9999)

res_adonis7 <- adonis_whole_infection$aov.tab
res_adonis7 <- fill_significance(res_adonis7,"Pr(>F)")

writeData(wb, "NMDS", "Effect of Wolbachia infection (HCA groups) and Strain in Culex pipiens", startCol = 1, startRow = 50)
writeData(wb, "NMDS", "ADONIS (Analysis of variance using distance matrices):", startCol = 1, startRow = 52)
writeData(wb, "NMDS", res_adonis7, startCol = 1, startRow = 54, rowNames=TRUE)

saveWorkbook(wb, "Supplementary_Table_2.xlsx", overwrite = TRUE)
```

## Effect of Wolbachia infection, qPCR values and Strain within Culex pipiens with qPCR values
```{r warning=FALSE}
setwd(path_xlsx)

# HCA Wolbachia infection * Strain in Culex pipiens with a qPCR value
ps_pipiens_whole_qpcr <- ps_pipiens_whole %>% subset_samples(qPCR_Ratio_Target_Ref >0)

adonis_whole_infection2 <- adonis(vegdist(t(otu_table(ps_pipiens_whole_qpcr)), method = "bray") ~qPCR_Ratio_Target_Ref*Infection*Strain,
       data=as(sample_data(ps_pipiens_whole_qpcr), "data.frame"), permutation = 9999)

res_adonis8 <- adonis_whole_infection2$aov.tab
res_adonis8 <- fill_significance(res_adonis8,"Pr(>F)")

writeData(wb, "NMDS", "Effect of Wolbachia infection (HCA groups), qPCR values and Strain in Culex pipiens with qPCR values", startCol = 1, startRow = 63)
writeData(wb, "NMDS", "ADONIS (Analysis of variance using distance matrices):", startCol = 1, startRow = 65)
writeData(wb, "NMDS", res_adonis8, startCol = 1, startRow = 67, rowNames=TRUE)

saveWorkbook(wb, "Supplementary_Table_2.xlsx", overwrite = TRUE)
```




